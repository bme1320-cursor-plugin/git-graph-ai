# Git Graph AI 缓存功能指南

## 概述

Git Graph AI 现在包含了强大的缓存系统，可以显著提升AI分析的性能并减少API调用次数。缓存系统采用两级架构：内存缓存和持久化磁盘缓存。

## 功能特性

### 🚀 性能优化
- **内存缓存**：快速访问最近使用的分析结果
- **磁盘缓存**：跨会话保持分析结果，避免重复分析
- **智能缓存键**：基于文件差异内容的SHA256哈希，确保缓存准确性

### 🧠 智能管理
- **LRU淘汰**：最近最少使用的缓存项会被自动清理
- **过期机制**：缓存项有生命周期，默认7天后自动过期
- **自动清理**：每小时自动清理过期的缓存项

### ⚙️ 高度可配置
- **缓存开关**：可以完全启用或禁用缓存功能
- **大小限制**：可配置内存和磁盘缓存的最大项数
- **生存时间**：可自定义缓存项的过期时间

## 配置选项

在VSCode设置中，您可以找到以下AI缓存相关配置：

### `git-graph.aiAnalysis.cache.enabled`
- **类型**: boolean
- **默认值**: true
- **描述**: 启用或禁用AI分析结果缓存

### `git-graph.aiAnalysis.cache.maxMemoryItems`
- **类型**: number
- **默认值**: 100
- **范围**: 10-1000
- **描述**: 内存缓存最大项数

### `git-graph.aiAnalysis.cache.maxDiskItems`
- **类型**: number
- **默认值**: 500
- **范围**: 50-5000
- **描述**: 磁盘缓存最大项数

### `git-graph.aiAnalysis.cache.ttlHours`
- **类型**: number
- **默认值**: 168 (7天)
- **范围**: 1-8760小时
- **描述**: 缓存项生存时间

## 使用方法

### 自动缓存
缓存功能完全自动化，无需手动干预：

1. **首次分析**：AI分析结果会自动缓存
2. **重复访问**：相同的文件差异会直接从缓存返回结果
3. **智能更新**：文件内容变化时会生成新的缓存项

### 手动管理

#### 查看缓存统计
```
命令面板 → "Git Graph AI: Show AI Cache Statistics"
```
显示：
- 内存缓存项数
- 磁盘缓存项数
- 总缓存大小
- 命中率（未来版本）

#### 清除缓存
```
命令面板 → "Git Graph AI: Clear AI Analysis Cache"
```
清除所有缓存数据，释放存储空间。

## 缓存工作原理

### 缓存键生成
```typescript
// 基于文件路径和差异内容生成唯一键
const cacheKey = sha256(`${filePath}:${diffContent}`)
```

### 缓存层级
1. **内存缓存**（L1）
   - 最快访问速度
   - 进程重启后清空
   - LRU淘汰策略

2. **磁盘缓存**（L2）
   - 持久化存储
   - 跨会话保持
   - 定期清理过期项

### 缓存命中流程
```
请求分析 → 检查内存缓存 → 检查磁盘缓存 → 调用AI服务 → 缓存结果
```

## 性能优势

### 响应时间对比
- **无缓存**: 2-10秒（取决于AI服务响应）
- **内存缓存命中**: < 10毫秒
- **磁盘缓存命中**: < 100毫秒

### API调用减少
- 相同文件的重复分析：减少100%的API调用
- 类似文件的分析：通过智能缓存键避免重复

## 存储位置

缓存文件存储在VSCode的全局存储目录中：
```
{VSCode Global Storage}/ai-cache/ai-analysis-cache.json
```

## 故障排除

### 缓存未生效
1. 检查 `git-graph.aiAnalysis.cache.enabled` 是否为 `true`
2. 查看VSCode开发者控制台是否有错误信息
3. 确认缓存目录有写入权限

### 缓存占用空间过大
1. 减少 `maxMemoryItems` 和 `maxDiskItems` 配置
2. 缩短 `ttlHours` 配置
3. 手动清除缓存

### 缓存数据过期
1. 检查 `ttlHours` 配置是否过短
2. 确认系统时间正确
3. 重新启动VSCode重新加载缓存

## 最佳实践

### 推荐配置
```json
{
  "git-graph.aiAnalysis.cache.enabled": true,
  "git-graph.aiAnalysis.cache.maxMemoryItems": 100,
  "git-graph.aiAnalysis.cache.maxDiskItems": 500,
  "git-graph.aiAnalysis.cache.ttlHours": 168
}
```

### 使用建议
1. **开发阶段**：保持缓存启用，提升开发效率
2. **代码审查**：缓存可以加速重复查看相同提交
3. **大型项目**：适当增加缓存大小限制
4. **存储敏感**：减少磁盘缓存项数或缩短TTL

## 监控和调试

### 日志信息
在VSCode输出面板的"Git Graph"通道中可以看到缓存相关日志：
```
[AI Cache] Hit: a1b2c3d4... (accessed 3 times)
[AI Cache] Miss: e5f6g7h8...
[AI Cache] Set: i9j0k1l2...
[AI Cache] Cleaned up 5 expired items from memory
```

### 性能指标
- 缓存命中率
- 平均响应时间
- 内存使用情况
- 磁盘空间占用

## 技术实现

### 架构设计
```
┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐
│   AI Service    │    │  Cache Manager  │    │  File System    │
│                 │    │                 │    │                 │
│ ┌─────────────┐ │    │ ┌─────────────┐ │    │ ┌─────────────┐ │
│ │ analyzeDiff │ │◄───┤ │ Memory Cache│ │    │ │ Disk Cache  │ │
│ └─────────────┘ │    │ └─────────────┘ │    │ └─────────────┘ │
└─────────────────┘    │ ┌─────────────┐ │    └─────────────────┘
                       │ │ LRU Eviction│ │
                       │ └─────────────┘ │
                       │ ┌─────────────┐ │
                       │ │ TTL Cleanup │ │
                       │ └─────────────┘ │
                       └─────────────────┘
```

### 关键组件
- **AiCacheManager**: 核心缓存管理器
- **AICacheItem**: 缓存项数据结构
- **AICacheConfig**: 缓存配置接口

## 未来计划

### 即将推出的功能
- [ ] 缓存命中率统计
- [ ] 缓存预热机制
- [ ] 分布式缓存支持
- [ ] 缓存压缩优化
- [ ] 智能缓存预测

### 性能优化
- [ ] 异步缓存写入
- [ ] 批量缓存操作
- [ ] 内存使用优化
- [ ] 缓存索引优化

---

## 反馈和支持

如果您在使用缓存功能时遇到任何问题或有改进建议，请通过以下方式联系我们：

- 提交Issue到项目仓库
- 在VSCode扩展评论区留言
- 通过邮件联系开发团队

感谢您使用Git Graph AI的缓存功能！🚀 